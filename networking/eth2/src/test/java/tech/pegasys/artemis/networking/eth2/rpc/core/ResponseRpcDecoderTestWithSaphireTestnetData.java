/*
 * Copyright 2020 ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 */

package tech.pegasys.artemis.networking.eth2.rpc.core;

import static org.assertj.core.api.Assertions.assertThat;

import io.netty.buffer.ByteBuf;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.function.Consumer;
import java.util.stream.Collectors;
import org.apache.tuweni.bytes.Bytes;
import org.junit.jupiter.api.Test;
import tech.pegasys.artemis.datastructures.blocks.SignedBeaconBlock;

public class ResponseRpcDecoderTestWithSaphireTestnetData extends RpcDecoderTestBase {

  private static final int blockCount = 6;
  private static final List<Bytes> originalChunks =
      List.of(
              "0x00",
              "0x8C03640000008EB0F217547FFC6A3AC218B4A9C9978FD1BA88C0C45486C82D64DBF53A84A0FF9A4DDB478FB00688E1E28A0F282E0C83048FA8E3A76DFF8AB81FC7D0337F745396973ABFAB94D973BA8CA76C1E6A927F4867A070A82027FC1327FA66E54E41D5D9000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490ED0B0A0E8A3DD32DAFAFE0F58C90D0094AB6DE0935894357BA524E8A1F5FB89934C00000091765915EE4CF78AF59473120A918CF80AB226541285C4AA099EC9B1EB10D64C4BA1CFA25DD2AB361AD46DBF2A9F03D9015DEF7AC233C5399925E09545D65AC20D2C3DDD41E64A61158FAA1912E16F288D6FB7FB05DE4535CFF4308EC641F753F488A7CA8DCB0C295BEA49A4FF4AFBDD1071150BFD2912E6EBD242A86239F99C6D6D000000000000CF291F1FAF97BE8B9149F199AAA18FBBC34359A7DE4A97C9F10BA22BFE38DCBCF09F928E76616C696461746F722D373764636434366239362D7474687373F09FDC000000DC000000DC000000DC000000DC000000",
              "0x00",
              "0x8C0364000000B44FEB11DC69F392B88648069B4392439882743B1FD592EA480B65BA6230399BD88FE69465C149DE10333E3803D07F340E8BD93C9990F06C04657DE3128F2CE34351C7019C4AA272EFCD8AA0A18B86C93C3F3318A39E15286E204E16C08CCD05DA00000000000000A47B3B282366334C3D928B19914B75920DF04731F7ABC1D50F5CC654F90CFF95FF0E0A98419B13FAD6737E5741B8C4595D9C4AF2ABDBA6E13F003C937086BAF04C00000083881FCFA8046D8BE6690192EB7CAE86193DA5400FC7971656032EB2606629602C7DD9F145A39669C91FA549BD30BE190A1546525A9C2294D30F9254C1C8DD64BA69BABC260A10B645F41B2E0F4C6949D2541B58F8AB67BA10B2D55447D47E89F488A7CA8DCB0C295BEA49A4FF4AFBDD1071150BFD2912E6EBD242A86239F99C6D6D000000000000CF291F1FAF97BE8B9149F199AAA18FBBC34359A7DE4A97C9F10BA22BFE38DCBCF09F928E76616C696461746F722D373764636434366239362D717A6B7A76F09FDC000000DC000000DC000000DC000000DC000000",
              "0x00",
              "0xE20E64000000905D4D65488269C151DC518067A237FDA47D3C4D4685A5AA9056EE1138BE90504076CDC1B9E7E66661E4B37E9E11D2670272DC32EF94557BB3595446778B7B8F0AEFB77CB23D001B810A4FBD20EDE1DE41295D72154EBAC07563874F99797379DB00000000000000ED3260E13CABCCDCD750E8797200F675E45B0BA4BF5434AC5E330C88815A06276D4DA31FAA1B13D3547E31B166D3E71517E57B07A70787D7023DE7B074D5644E4C000000B1AA5C214778D13137A32343DAADCF19B9F93BEF46359B4E3129D48A825F9364CD53278822A0E01B6B58C1227B02B09E171AD5918822B7BF04BFB65A52A56216E356387310DD40C3EA327ADF95EEE14CEB0C5375121F92203FC20187F6F033E2F488A7CA8DCB0C295BEA49A4FF4AFBDD1071150BFD2912E6EBD242A86239F99C6D6D000000000000CF291F1FAF97BE8B9149F199AAA18FBBC34359A7DE4A97C9F10BA22BFE38DCBCF09F928E76616C696461746F722D373764636434366239362D3278346C76F09FDC000000DC000000DC000000B2060000B2060000180000000D01000002020000F7020000EC030000E1040000E4000000DA000000000000000300000000000000ED3260E13CABCCDCD750E8797200F675E45B0BA4BF5434AC5E330C88815A06270000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EA1EE9FBB8AC2AD1710116A16066B21FDF65105B3E98BD61E4FFED07F65C3030A6D4315B9C9E83AE47A9791E084C99A4C0AF59B5CE7A9C6DE43C15CDF09FCEED4CF5E89E3DD5BAB30B8022B290A937B477268D2C6EA633A06AC2AAE6C588F9FC30040089800220104202408044C41040601E4000000DA000000000000000100000000000000ED3260E13CABCCDCD750E8797200F675E45B0BA4BF5434AC5E330C88815A06270000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EB8F765381C0DCC9DE5E18956AD8F89C5F817475031019E18922C5CAD8DFF071FDADFC3DFB102E0784D6914B60E323D620885614373B29E1248FF81A980E2E15B9F4261FBB92F3899D248D5EC3F25FFC3B04FD4E1E945090D886D841A4C27E54910000000012021200010404040888A8C01E4000000DA000000000000000200000000000000ED3260E13CABCCDCD750E8797200F675E45B0BA4BF5434AC5E330C88815A06270000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EAEA99D7FC19B4363C9E749411472F22F6876BE694862FE44B4AE64E63D792AA221CE0455E76A4B23A659CEF23B97B00E0C06DFF1117E9B8E822C34467FE276E84F9A28FCEB326E89E38F9B4119AD55BA300FCBC43B4F578E79F67EC1038FFE592000000000042800048002C00C00300601E4000000DA000000000000000100000000000000ED3260E13CABCCDCD750E8797200F675E45B0BA4BF5434AC5E330C88815A06270000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EA03E842ED70BBB25E3A7E9185DB475CC64195FB066FC89E4807A8B2D2AF2FE8A7E491E60E38556E9B0A8456F493ED90609E6EB47341C7B6C6F9BF384A5AEE2246F8FE48B48E69C495C9C14E1A243A88A3E021A20D869675A4D1C0FD6E8B8167EEFFFFFFFFECFDED7FFEFBFBFBF77757301E4000000DA000000000000000000000000000000ED3260E13CABCCDCD750E8797200F675E45B0BA4BF5434AC5E330C88815A06270000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EAB09F9AC91141D9F98CCB345456CC925FF3A95FB7689B4492D6C283691567BD5B00CA16762136D278186E390A70E168F183AEE0C7F7668D4C1C7122F5AF7747CEEDB77F7F2507AF9588F99DEDAA444F39DAFE83D9977D16A3920AA89D63B192DFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFF01E4000000DA000000000000000300000000000000ED3260E13CABCCDCD750E8797200F675E45B0BA4BF5434AC5E330C88815A06270000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EB7AA863357E40AF6866AB549ABB22F02813D8039284B2C3B3CEE0F609900BD0E39E6638ADBE856BDDD0FC3CA827B0B4713CC89EEA409C506918687A073C87318F260C29F364DE409FC2FBC3F4713333211A904D872C69EB7D070C0609E999EA9FFBFF767EFDDFEFBDFDBF7F3B3BEFBF901",
              "0x00",
              "0xD41264000000A80F94F4495E766586B360D973238AE3CFBA469DC642B1EAB37171EC0E45D66514DD094D7C75BA816B73CE740CEDEDB10C947278553EBFD2C183364D5081E5111874F32E95FF637A986D271C3465652F317710B4ED461A8479E0E71B58A9F056DC00000000000000A6D058596E4D772F8C6CB03FDB69748D2456FE421E4F225B2E37B69C6BB52C316E21ECD0E4D8334AB84F8C84AC6E98C62E275F69EC7B31AE2C66503FC46EB95C4C00000091CE0113DDDAEB43710D501FA81195C7FB9CFCA029DEE2DBF6D0FE6766A78465E9CED42E748EBFB9CFD673AC6C32974B106C94CB2001CDD24398C4BC3D5E3B7DDB589FB32513E74CF85B24766D8AF331CB5ECBA87178335A7D8BA19C9DB8438FF488A7CA8DCB0C295BEA49A4FF4AFBDD1071150BFD2912E6EBD242A86239F99C6D6D000000000000CF291F1FAF97BE8B9149F199AAA18FBBC34359A7DE4A97C9F10BA22BFE38DCBCF09F928E76616C696461746F722D373764636434366239362D717A6B7A76F09FDC000000DC000000DC000000A4080000A408000020000000150100000A020000FF020000F4030000E9040000DE050000D3060000E4000000DB000000000000000200000000000000A6D058596E4D772F8C6CB03FDB69748D2456FE421E4F225B2E37B69C6BB52C310000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EA4B1AC00CCDF22EF20EFECE9AFF0920152F418356EA523CBC9F885FB4A8124875DCE8065202E07479F558EF1D90D8D181321C5E4DBCE08F60869EAA251E715F20C7630F920685F612C6B0D477685FC1342BD6B0862A9E27523F6AA7711D265B90210000000890008000010020810200001E4000000DB000000000000000100000000000000A6D058596E4D772F8C6CB03FDB69748D2456FE421E4F225B2E37B69C6BB52C310000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EB1FEA1E4E5C990A64C2471208FB78EAB82948D97D2674A68B85598D07C8CECD60A5690F6955C1793F614E07B74F474EC02F342233E4364B63F21AA3AE943AB0BE5FA01DB1C23FFC530A0190A1796256AD7DF0695CA429EEE1D353EB937E221A08200000041008000051001000040000001E4000000DB000000000000000000000000000000A6D058596E4D772F8C6CB03FDB69748D2456FE421E4F225B2E37B69C6BB52C310000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EAD5ABD27561E114D856A075D184268A42AFF52E674094E48824AFB2F3E12F5F5B3D8058FD4E4CB47FEDE0B348F144C4905D6537A96ACBB05ECDF5A156E3CAFA416D572CF9178EA41BA84598E7F22E94F56CEC39B881EDD1F7855DB25D1B419CDFFFFEFDFFFBF76FFBDDFFFFFFFF6FFFF01E4000000DB000000000000000100000000000000A6D058596E4D772F8C6CB03FDB69748D2456FE421E4F225B2E37B69C6BB52C310000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EB3C8A50622D85F92E6687ED122D3E5D8B556751A5BF2E6B9E528DE37A367C2D3ECCB93AC8B7CCAD2494E9388345887D60844811DC7B47BB603479F19717F54AA621C356A4A6B8E6BF7AF9649FFB26808EFE3A04990E6BAAA0E6FD8A6BE4D59AE7DFFFFFFBEFF7FFFFAEFFEFFFFBFFBFF01E4000000DB000000000000000300000000000000A6D058596E4D772F8C6CB03FDB69748D2456FE421E4F225B2E37B69C6BB52C310000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EB92A1C2B018F4836E90EADF24CE353C43EA011FCF53F659B420CE765A24189CCAD54F9FD29F309CC8073EF1281E105DB0BBC91E0ED03268469D27B3396C71AFFA2E0E43B03221B114727C4FCF2D702246F9247B7829CFE5F7571E469A9FD67CAFFFEFFEFFFFF7DFFFF5F7FFFFFFE7FFF01E4000000DB000000000000000200000000000000A6D058596E4D772F8C6CB03FDB69748D2456FE421E4F225B2E37B69C6BB52C310000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E916030B97C6883ACF2E12EB47010A3B084B81881E5F0FB757687C89B9DFBFA814E12C1193C186C4917502427E46EE2450BC88BA05280B5DFF1608B984DD99FDE4F952499248382F78EA26D9E8F2528B428487AC29C74F991DC5C564E748B9F89FDEFFBFFFF76F7D7FFFFEFFDF7EFDFFF01E4000000DB000000000000000000000000000000A6D058596E4D772F8C6CB03FDB69748D2456FE421E4F225B2E37B69C6BB52C310000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EB6BDDF01CB34A10AFF1F8072F7BE49726410C19AF4BC5FDE1411B6ADC12613A9AABBA62B3D6D1A2A8A6386C5D7093CF5161EAE65206E90382E32DBF3E3BA553972F4E43A5F268E45BCA1FFA167EDBCC751B91BA7F4068A265FE5DC73415335320000100000408900022000000009000001E4000000DB000000000000000300000000000000A6D058596E4D772F8C6CB03FDB69748D2456FE421E4F225B2E37B69C6BB52C310000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E98A0E4E156C1384C610581404B60760D6614A209BA74E5C3ED7E7D7B7CAB2E5AC79DB1731FDB0F1F653B4FE6587AF99619E8C4F6EB8CBA1F273B46ED212F0C02C74BD4FA56435D48FBB4459BE7834B3A2AC676BB197E00157E31F7D65DF0E7D3000100100000820000A080000001800001",
              "0x00",
              "0xF00A64000000B2717398B5B10FB959C92357ADDCAC358D2A65E958AA27D10FD5E116DA3D12FE9FBA38C92E252D663345B982C90A419A0C9EA70D1DAFD7970D0845DC670C73A927EE6C65C9502565C7A637BE53337C9771661AC0231A95A737F80903ECAD8299DD0000000000000060FDDC61FCBE2DE59B165C8420907AB756759764BCADF56C7393E766CD1778F605F8CB09A3B3E878ED302EEDCF6AB79F670DA8C2E01604674C3AB1B3C34963644C000000A0AE04198E69F0A125CA54A2228EFFADC5B7A9E7D037BEF9F0E085D690776699662C0A12D448C7A5BBC2618A72C0B33E19B146330300E03E8859A68E16DBE44A5C95486AF33CA98EBAEBF2ED8A07021773051B633E4CA5A87D179865484615C1F488A7CA8DCB0C295BEA49A4FF4AFBDD1071150BFD2912E6EBD242A86239F99C6D6D000000000000CF291F1FAF97BE8B9149F199AAA18FBBC34359A7DE4A97C9F10BA22BFE38DCBCF09F928E76616C696461746F722D373764636434366239362D64676B6B71F09FDC000000DC000000DC000000C0040000C00400001000000005010000FA010000EF020000E4000000DC00000000000000010000000000000060FDDC61FCBE2DE59B165C8420907AB756759764BCADF56C7393E766CD1778F60000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EA92B1B1C80654748F90BBB2C9F63CEBF5DAF49448F035A5BD2B61D2EA336AFABA2023975BFB866DF31E7D37231ED420B172B4155A6C1615E53B69D50839F9B0AE75C349372FD4B8F1ED557D41822A48559552833BA769950FFFEAC53798903F5FFFDFFFFFFFFFFFFEFFF7FFFFFFFFFF701E4000000DC00000000000000030000000000000060FDDC61FCBE2DE59B165C8420907AB756759764BCADF56C7393E766CD1778F60000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E98688D2BE6A43B46E1A02022F7AF2A296494D9A9C001E19979A76EF54D91B90F78CF02A623D009EA01B13CFA9A8A99AA00F741B38BBAA64054DDDC0075AE5052854B1E00D834081802FFF5636B997F4E23E724D16331086A806D69AC0580F292FFFFFFFFFBFFFFFFFBFBFFFFFFFFFFFF01E4000000DC00000000000000020000000000000060FDDC61FCBE2DE59B165C8420907AB756759764BCADF56C7393E766CD1778F60000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E806B2DF0ED5325349AEE485758CF4B0DB236D5F6A0915AD7DDCDD35DDF5891B45DDF80C67CC409B96A0F2F141BC975820E5807AE1E3570C3BB6F54264E54BA076B4DDA8BAE709E4D9CD9C20685ADCEB0B2CA71674568F1161873DE39D337B87AFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF01E4000000DC00000000000000000000000000000060FDDC61FCBE2DE59B165C8420907AB756759764BCADF56C7393E766CD1778F60000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E806D182D6AF4B27237B94DEC53C38C1949F9E87976423872CED6564BCB2EF330C2EC1B959B27FE0F159F5C73CE6325F1170305EE778BFBE0DA43A7454B9F33BBDBFFD6AA6940B5DBFB02CDE8C49C3B53A3397F683144C0F5A6C3663049103063FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF01",
              "0x00",
              "0xD41264000000B89AB6CD216996AF796F42CC8D12B16A96182E4BA64F236CECE98BDA0D935054D8E6D80EEEDB99436005CF2E457AE2D217862C069ED57A7A038F46AD4790DC67A9C674A498D65F1D3FC30C451D5BD59C389D30A13609CD75539B4C96EA399B2CDE00000000000000284FD9586CA7A86768E9A5695C2F1D34D528487C35155FB7F14F8B203C3AF2FC36CAD4238B7C9BB509B531771234CF3BFA399707658E4781CE67F3B38211955F4C000000A7441D2F143C569427A545382D7683B9EBBF2802581746C33D136B8020944A8BF03DDB763AA3164DC0558DC9A8B3AB98183A03D3371B0C037A7A25895775CE663F5A32D4B3DA385EDE4A5CFD00AF77FFDF6FB9235463F580139267DC774C41BEF488A7CA8DCB0C295BEA49A4FF4AFBDD1071150BFD2912E6EBD242A86239F99C6D6D000000000000CF291F1FAF97BE8B9149F199AAA18FBBC34359A7DE4A97C9F10BA22BFE38DCBCF09F928E76616C696461746F722D373764636434366239362D327374327AF09FDC000000DC000000DC000000A4080000A408000020000000150100000A020000FF020000F4030000E9040000DE050000D3060000E4000000DD000000000000000200000000000000284FD9586CA7A86768E9A5695C2F1D34D528487C35155FB7F14F8B203C3AF2FC0000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EB997C170CE715FE72AEC25DEEAA9B10C6741ADB93F35A5DE2392FF0C88F09876157D0D1EAE48BF9DDDCD97362EB439D7179DB0700E501118FBA0500504102FB6B3B29ADA8C1169F21841C91F97930BFF94AC11A8666D592E0796575FF62957188004000000300001040010001080901101E4000000DD000000000000000000000000000000284FD9586CA7A86768E9A5695C2F1D34D528487C35155FB7F14F8B203C3AF2FC0000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490EAF563E71587652F4CA8D52926F1E33F8BB8DA85599CDD88E8D64532286CA1B6AE1E4425A77EF94E6BCC7689D67992D050B749DA00929244277668CF582CE5B53B3CA284E008AB5AB76087D87AF7F093579522CE9F1B79C82D1EE68A35A098EFC2200004900004942100400000400420001E4000000DD000000000000000100000000000000284FD9586CA7A86768E9A5695C2F1D34D528487C35155FB7F14F8B203C3AF2FC0000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E81E7A1761B1CDF6243E202F5CECBE311858AD148B3CEF0DD1B4B500EE6912F4A6CC52AA60985C25281E628D466CEBC200A09866457605D4CAE81F31A1F848DFF79D416EA1F697E0715C4D072671D06AD7C0247723AF21A269A115A77CF3199D41240090100010004200000100004040001E4000000DD000000000000000100000000000000284FD9586CA7A86768E9A5695C2F1D34D528487C35155FB7F14F8B203C3AF2FC0000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E905CB1D4116AD13F5EAA4A4EC5FDE9605E9EE62AB03831D1E004E15431BDC5975B52A878C3EB550D3B1504E5323C83C40E295FF7CD69CA47434CD0CEDC12B28CF5869C23D5E79356C5AD3057BEFAFDFC08BC7344666EC953E5D9805B73D5E236ED3FF6F6FFFEFFFBDFFFFFEFFFBAFBFF01E4000000DD000000000000000200000000000000284FD9586CA7A86768E9A5695C2F1D34D528487C35155FB7F14F8B203C3AF2FC0000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E9135A5F9A3691484DBA3713F628511C75AE0B8A41E29DA8078DFB576884BF092C177EF991D26D0A3D01E3ABC8B88E49414666BCAE1590CC0D79ED92CA9067533C1090B17F2CE71292F09D2A6E48583534497F7878C8A684B65E1A4BF6777FC257DFBFFFFFFCFF7FEFBFFEFF7EF7F6FEE01E4000000DD000000000000000000000000000000284FD9586CA7A86768E9A5695C2F1D34D528487C35155FB7F14F8B203C3AF2FC0000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E8F37E67ACA8BB7C260159321FDEF25D2136F9569DBFBC5C9D7A48B8ACDB5B1672139666196AC4134D07C9AF0245244B6143B87CE0799C529A8564B8271C7D0395A2D21CCC5D36F875DF40D56098071800C22C320BC97389D406A5F7E39E95260DDF7FFB6FFFFB6BDEFFBFFFFFBFFBD3F01E4000000DD000000000000000300000000000000284FD9586CA7A86768E9A5695C2F1D34D528487C35155FB7F14F8B203C3AF2FC0000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E82C22FBF74BCD237F87F01DD083F93F41B389978D114204CCD2C9F0EBF8B46F8632933851F59BDC2C6AD37A89028DF4B1178FA3186BBF24F9EE1997B903D6D26D367F9F43904D5430D6710FB1CBBA608D6D63DD2C196EC62D3624B1348B7B7F9BFFEF7F6FFBFFF7FFFCFFFBFBB7FEEFF01E4000000DD000000000000000300000000000000284FD9586CA7A86768E9A5695C2F1D34D528487C35155FB7F14F8B203C3AF2FC0000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000008B25301BDEBA020D4226E949EAE0ECEFB8863E060B7844566D51E0A42ED6490E829FBA446C9A252E5D8944B2D8E64EC65AFF122E20C85CB5B7FFF27B40C9E26C9326A45D0EF1F7165B9B9145514A470A0B9C508FBB8AFFF4428166C1D7AAD8FBCC929CAEC5AB9130E9146332C78C48D323FF058990D67598A26AED687CAEA26D4001080900400080003000004400110001")
          .stream()
          .map(Bytes::fromHexString)
          .collect(Collectors.toList());

  private static final Bytes combinedData = Bytes.concatenate(originalChunks.toArray(new Bytes[0]));

  private final List<SignedBeaconBlock> receivedBlocksByRange = new ArrayList<>();
  private final Consumer<SignedBeaconBlock> blocksByRangeCallback = receivedBlocksByRange::add;
  private final ResponseRpcDecoder<SignedBeaconBlock> blocksByRangeDecoder =
      new ResponseRpcDecoder<>(blocksByRangeCallback, BEACON_CHAIN_METHODS.beaconBlocksByRange());

  @Test
  public void processOriginalChunks() throws Exception {

    ByteBuf buf;
    for (Bytes chunk : originalChunks) {
      buf = buffer(chunk);
      blocksByRangeDecoder.onDataReceived(buf);
    }

    assertThat(receivedBlocksByRange.size()).isEqualTo(blockCount);
  }

  @Test
  public void processRecombinedChunks_twoRoughlyEqualChunks() throws Exception {
    testProcessingRecombinedChunks(7);
  }

  @Test
  public void processRecombinedChunk_firstChunkThenTheRest() throws Exception {
    testProcessingRecombinedChunks(1);
  }

  @Test
  public void processRecombinedChunks_lastChunkSentAlone() throws Exception {
    testProcessingRecombinedChunks(originalChunks.size() - 1);
  }

  @Test
  public void processRecombinedChunks_multipleCombinedChunks() throws Exception {
    testProcessingRecombinedChunks(1, 3, 8);
  }

  private void testProcessingRecombinedChunks(final Integer... boundaryIndexes) throws Exception {
    final List<Integer> segmentEndIndexes =
        Arrays.stream(boundaryIndexes).collect(Collectors.toList());
    segmentEndIndexes.add(originalChunks.size());

    int startIndex = 0;
    for (int i = 0; i < segmentEndIndexes.size(); i++) {
      final int endIndex = segmentEndIndexes.get(i);
      final ByteBuf buf =
          buffer(originalChunks.subList(startIndex, endIndex).toArray(new Bytes[0]));
      blocksByRangeDecoder.onDataReceived(buf);

      startIndex = endIndex;
    }

    assertThat(receivedBlocksByRange.size()).isEqualTo(blockCount);
  }

  @Test
  public void processArbitrarySegments_bytesSplitInHalf() throws Exception {
    testProcessingArbitrarySegments(combinedData.size() / 2);
  }

  @Test
  public void processArbitrarySegments_firstByteThenEverythingElse() throws Exception {
    testProcessingArbitrarySegments(1);
  }

  @Test
  public void processArbitrarySegments_everythingThenLastByte() throws Exception {
    testProcessingArbitrarySegments(combinedData.size() - 1);
  }

  @Test
  public void processArbitrarySegments_multipleSegments() throws Exception {
    final int size = combinedData.size();
    testProcessingArbitrarySegments(size / 5, size / 4, size * 11 / 20, size * 9 / 10);
  }

  @Test
  public void processArbitrarySegments_splitSecondBlockAcrossMultipleBuffers() throws Exception {
    final int firstBlockSize = originalChunks.get(0).size() + originalChunks.get(1).size();
    final int secondBlockSize = originalChunks.get(2).size() + originalChunks.get(3).size();
    testProcessingArbitrarySegments(
        firstBlockSize + secondBlockSize / 3, firstBlockSize + secondBlockSize / 3 + 10);
  }

  private void testProcessingArbitrarySegments(final Integer... byteBoundaryIndexes)
      throws Exception {
    final List<Integer> byteEndIndexes =
        Arrays.stream(byteBoundaryIndexes).collect(Collectors.toList());
    byteEndIndexes.add(combinedData.size());

    int startIndex = 0;
    for (int i = 0; i < byteEndIndexes.size(); i++) {
      final int endIndex = byteEndIndexes.get(i);
      final int size = endIndex - startIndex;
      final ByteBuf buf = buffer(combinedData.slice(startIndex, size));
      blocksByRangeDecoder.onDataReceived(buf);

      startIndex = endIndex;
    }

    assertThat(receivedBlocksByRange.size()).isEqualTo(blockCount);
  }
}
