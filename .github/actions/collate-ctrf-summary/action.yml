---
name: 'ctrf-summary'
description: 'Composite action to gather all test results'

runs:
  using: "composite"
  steps:
    - name: Gather ctrf reports
      uses: actions/download-artifact@v4
      with:
        pattern: ctrf-*
        path: ctrf/
        # merge-multiple: true

    - shell: bash
      run: |
        tree ctrf/
    
    - name: Publish combined summary
      shell: bash
      run: |
        echo "#Combined Test Reports" > combined-report.md
        echo "**Workflow run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> combined-report.md
        echo "" >> combined-report.md

        for dir in ctrf/ctrf-*; do
          suite=$(basename "$dir" | sed 's/^ctrf-//' | sed 's/-tests$//')
          echo "" >> combined-report.md
          echo "## 🔹 ${suite^} Tests" >> combined-report.md
          if [ -f "$dir/ctrf-report.md" ]; then
            cat "$dir/ctrf-report.md" >> combined-report.md
          else
            echo "_⚠️ No markdown report found for ${suite}_." >> combined-report.md
          fi
          echo "" >> combined-report.md
        done

    # Truncate safely before publishing to summary (GitHub limit = 1024 KB)
    - name: Publish truncated summary to workflow
      run: |
        echo "## Combined Test Summary (truncated to fit 1 MB limit)" > summary.md
        # keep first ~900 KB to stay below the GitHub summary limit
        head -c 900000 combined-report.md >> summary.md
        echo -e "\n\n_📦 Full report available below as downloadable artifact._" >> summary.md
        cat summary.md >> $GITHUB_STEP_SUMMARY

    # Upload the full Markdown as an artifact
    - name: Upload full combined test report
      uses: actions/upload-artifact@v4
      with:
        name: full-ctrf-summary
        path: combined-report.md
